"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.insert = exports.$insertify = void 0;
const reflection_1 = require("../reflection");
const path_1 = require("./path");
const query_1 = require("./query");
function unlessConflict(conflictGetter) {
    const expr = {
        __kind__: reflection_1.ExpressionKind.InsertUnlessConflict,
        __element__: this.__element__,
        __cardinality__: reflection_1.Cardinality.One,
        __expr__: this,
    };
    if (!conflictGetter) {
        expr.__conflict__ = { on: null };
        return (0, path_1.$expressionify)((0, query_1.$queryify)(expr));
    }
    else {
        const scopedExpr = (0, path_1.$expressionify)({
            ...this.__expr__,
            __cardinality__: reflection_1.Cardinality.One,
        });
        expr.__conflict__ = conflictGetter(scopedExpr);
        return (0, path_1.$expressionify)((0, query_1.$queryify)(expr));
    }
}
function $insertify(expr) {
    expr.unlessConflict = unlessConflict.bind(expr);
    return (0, query_1.$queryify)(expr);
}
exports.$insertify = $insertify;
function insert(root, shape) {
    const expr = {
        __kind__: reflection_1.ExpressionKind.Insert,
        __element__: root.__element__,
        __cardinality__: reflection_1.Cardinality.One,
        __expr__: root,
        __shape__: shape,
    };
    expr.unlessConflict = unlessConflict.bind(expr);
    return (0, path_1.$expressionify)($insertify(expr));
}
exports.insert = insert;
